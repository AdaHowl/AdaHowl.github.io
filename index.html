<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haxball Clone</title>
  <style>
    canvas {
      background: white;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const keys = {};
  document.addEventListener("keydown", (e) => (keys[e.code] = true));
  document.addEventListener("keyup", (e) => (keys[e.code] = false));

  class Player {
    constructor(x, y, color, controls, speedModifier = 1) {
      this.x = x;
      this.y = y;
      this.radius = 20;
      this.color = color;
      this.controls = controls;
      this.speedModifier = speedModifier;
      this.vx = 0;
      this.vy = 0;
    }

    update() {
      const speed = 1.2 * this.speedModifier;
      this.vx = 0;
      this.vy = 0;
      if (keys[this.controls.up]) this.vy = -speed;
      if (keys[this.controls.down]) this.vy = speed;
      if (keys[this.controls.left]) this.vx = -speed;
      if (keys[this.controls.right]) this.vx = speed;

      this.x += this.vx;
      this.y += this.vy;

      // Giữ trong canvas
      this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
      this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));
    }

    draw() {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
      ctx.fillStyle = this.color;
      ctx.fill();
    }
  }

  class Ball {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.radius = 10;
      this.vx = 0;
      this.vy = 0;
    }

    update() {
      this.x += this.vx;
      this.y += this.vy;

      // friction
      this.vx *= 0.985;
      this.vy *= 0.985;

      // Wall collision
      if (this.x < this.radius || this.x > canvas.width - this.radius) {
        this.vx *= -1;
        this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
      }
      if (this.y < this.radius || this.y > canvas.height - this.radius) {
        this.vy *= -1;
        this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));
      }
    }

    draw() {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
      ctx.fillStyle = "black";
      ctx.fill();
    }
  }

  const player1 = new Player(100, 200, "red", {
    up: "KeyW",
    down: "KeyS",
    left: "KeyA",
    right: "KeyD"
  }, 1);

  const player2 = new Player(700, 200, "blue", {
    up: "ArrowUp",
    down: "ArrowDown",
    left: "ArrowLeft",
    right: "ArrowRight"
  }, 0.85); // Chậm hơn chút

  const ball = new Ball(400, 200);

  let score = [0, 0];
  const goalWidth = 100;
  const goalHeight = 100;

  function detectCollision(p, b) {
    const dx = b.x - p.x;
    const dy = b.y - p.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    if (distance < p.radius + b.radius) {
      const angle = Math.atan2(dy, dx);
      const force = 1.5;
      b.vx = Math.cos(angle) * force;
      b.vy = Math.sin(angle) * force;
    }
  }

  function checkGoal() {
    if (
      ball.y > canvas.height / 2 - goalHeight / 2 &&
      ball.y < canvas.height / 2 + goalHeight / 2
    ) {
      if (ball.x < ball.radius) {
        score[1]++;
        resetGame();
      } else if (ball.x > canvas.width - ball.radius) {
        score[0]++;
        resetGame();
      }
    }

    if (score[0] === 5 || score[1] === 5) {
      score = [0, 0];
      resetGame();
    }
  }

  function resetGame() {
    ball.x = canvas.width / 2;
    ball.y = canvas.height / 2;
    ball.vx = 0;
    ball.vy = 0;

    player1.x = 100;
    player1.y = 200;
    player2.x = 700;
    player2.y = 200;
  }

  function drawGoals() {
    ctx.fillStyle = "lightgray";
    ctx.fillRect(0, canvas.height / 2 - goalHeight / 2, 5, goalHeight);
    ctx.fillRect(canvas.width - 5, canvas.height / 2 - goalHeight / 2, 5, goalHeight);
  }

  function drawScore() {
    ctx.font = "24px Arial";
    ctx.fillStyle = "black";
    ctx.fillText(`${score[0]} - ${score[1]}`, canvas.width / 2 - 30, 30);
  }

  function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    player1.update();
    player2.update();
    ball.update();

    detectCollision(player1, ball);
    detectCollision(player2, ball);
    checkGoal();

    drawGoals();
    drawScore();
    player1.draw();
    player2.draw();
    ball.draw();

    requestAnimationFrame(gameLoop);
  }

  gameLoop();
</script>
</body>
</html>